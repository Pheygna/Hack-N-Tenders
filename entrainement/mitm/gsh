#!/bin/bash

step_file="/root/.mitm_step"
if [ ! -f "$step_file" ]; then echo 1 > "$step_file"; fi
step=$(cat "$step_file")

# Ã‰tape 1 : Analyse du rÃ©seau
if [[ "$step" == "1" ]]; then
    echo -e "\nğŸ“˜ \033[36mÃ‰tape 1 : Analyse du rÃ©seau\033[0m"
    echo "Fichier : /tmp/network_capture.txt"
    echo "Regardez les requÃªtes ARP ou DNS anormales"
    echo -e "\033[33mIndice : une attaque ARP spoofing est peut-Ãªtre visible\033[0m"
    
    read -p "Avez-vous analysÃ© le fichier ? (y/n) : " read_net
    if [[ "$read_net" != "y" ]]; then
        echo -e "\033[31mVeuillez lire le fichier avec : grep -i 'who has' /tmp/network_capture.txt | sort | uniq -c \033[0m"
        echo "Puis relancez : gsh"
        exit 0
    fi

    read -p "Avez-vous repÃ©rÃ© un comportement rÃ©seau suspect ? (y/n) : " resp
    if [[ "$resp" == "y" ]]; then
        echo -e "\033[32mâœ… Ã‰tape 1 validÃ©e !\033[0m"
        echo 2 > "$step_file"
        exit 0
    else
        echo -e "\033[31mâŒ Ce fichier contient un comportement anormal. Regardez les adresses MAC.\033[0m"
        exit 0
    fi
fi


# Ã‰tape 2 : Inspection certificat
if [[ "$step" == "2" ]]; then
    echo -e "\nğŸ“˜ \033[36mÃ‰tape 2 : Inspection d'un certificat\033[0m"
    echo "Fichier : /tmp/fake_cert.pem"
    echo -e "\033[33mAvant de rÃ©pondre, vous pouvez examiner le fichier avec :\033[0m"
    echo -e "   \033[32mcat /tmp/fake_cert.pem\033[0m"
    echo

    read -p "ğŸŸ¡ Avez-vous examinÃ© le certificat ? (y/n) : " examined
    if [[ "$examined" != "y" ]]; then
        echo -e "\033[31mVeuillez d'abord examiner le certificat, puis relancez : gsh\033[0m"
        exit 0
    fi

    read -p "ğŸŸ¡ Ce certificat est-il lÃ©gitime ? (oui/non) : " answer
    if [[ "$answer" == "non" || "$answer" == "n" ]]; then
        echo -e "\033[32mâœ… Ã‰tape 2 validÃ©e !\033[0m"
        echo 3 > "$step_file"
    else
        echo -e "\033[31mâŒ Mauvaise rÃ©ponse. Indice : vÃ©rifiez lâ€™Ã©metteur, la validitÃ© et le CN (Common Name).\033[0m"
    fi
    exit 0
fi


# Ã‰tape 3 : Analyse des logs SSL
if [[ "$step" == "3" ]]; then
    echo -e "\nğŸ“˜ \033[36mÃ‰tape 3 : Analyse des logs SSL/TLS\033[0m"
    echo "Fichier : /tmp/ssl_logs.txt"
    echo "RepÃ©rez une interception ou une anomalie de communication"

    read -p "ğŸŸ¡ Avez-vous examinÃ© les logs ? (y/n) : " examined
    if [[ "$examined" != "y" ]]; then
        echo -e "\033[31mVeuillez lire le fichier avec : grep 'WARNING' /tmp/ssl_logs.txt\033[0m"
        echo "Puis relancez : gsh"
        exit 0
    fi

    read -p "Avez-vous identifiÃ© un comportement suspect ? (y/n) : " read_ssl
    if [[ "$read_ssl" != "y" ]]; then
        echo -e "\033[31mConseil : recherchez les connexions TLS man-in-the-middle.\033[0m"
        exit 0
    fi

    read -p "ğŸŸ¡ Quelle anomalie est prÃ©sente dans la trace ? : " ssl_answer
    if echo "$ssl_answer" | grep -iq "pas\|self-signed\|intercepted\|faux certif"; then
        echo -e "\033[32mâœ… Ã‰tape 3 validÃ©e !\033[0m"
        echo 4 > "$step_file"
    else
        echo -e "\033[31mâŒ Ce nâ€™est pas la bonne rÃ©ponse. Indice : comparez les certificats.\033[0m"
    fi
    exit 0
fi

# Ã‰tape 4 : Observation simplifiÃ©e du trafic rÃ©seau
if [[ "$step" == "4" ]]; then
    echo -e "\nğŸ“˜ \033[36mÃ‰tape 4 : Observation du trafic rÃ©seau\033[0m"
    echo "Fichier : /tmp/network_traffic.txt"
    echo "Consultez ce fichier pour repÃ©rer une activitÃ© HTTP ou rÃ©seau anormale."
    echo -e "\033[33mCommande suggÃ©rÃ©e : \033[32mcat /tmp/network_traffic.txt\033[0m"

    read -p "ğŸŸ¡ Avez-vous consultÃ© le fichier ? (y/n) : " seen_file
    if [[ "$seen_file" != "y" ]]; then
        echo -e "\033[31mVeuillez consulter le fichier rÃ©seau avant de continuer.\033[0m"
        exit 0
    fi

    read -p "ğŸŸ¡ Quelle anomalie rÃ©seau avez-vous repÃ©rÃ©e ? : " network_issue
    if echo "$network_issue" | grep -iq "http\|credential\|plain\|injection\|cleartext"; then
        echo -e "\033[32mâœ… Ã‰tape 4 validÃ©e !\033[0m"
	echo ""
	echo -e "\nğŸ‰ \033[32mFÃ©licitations, vous avez terminÃ© le scÃ©nario MITM !\033[0m"
        echo -e "ğŸ›¡ï¸ Pensez Ã  sÃ©curiser vos communications rÃ©seau avec HTTPS, DNSSEC et des certificats valides."
    else
        echo -e "\033[31mâŒ RÃ©ponse incorrecte. Indice : cherchez des mots de passe ou requÃªtes HTTP en clair.\033[0m"
    fi
    exit 0
fi
