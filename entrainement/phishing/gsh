#!/bin/bash

step_file="/tmp/.phish_steps"
not_read_flag="/tmp/.not_read"

# Initialisation de l'Ã©tape
if [ ! -f "$step_file" ]; then
  echo 1 > "$step_file"
fi

step=$(cat "$step_file")
echo -e "\033[90mDEBUG: step=$step\033[0m"

# Ã‰tape 1 : Lecture du mail
if [ "$step" = "1" ]; then
  echo -e "ğŸ“˜ \033[36mÃ‰tape 1 : Lecture de l'email\033[0m"
  echo ""
  echo "Fichier Ã  consulter : /tmp/suspect_email.txt"
  echo "Utilisez la commande : cat /tmp/suspect_email.txt"
  echo -e "\033[33m(Note : La rÃ©ponse ne sera disponible qu'aprÃ¨s lecture du fichier)\033[0m"

  echo -ne "\nAvez-vous lu le fichier ? (y/n) : "
  read lu
  if [ "$lu" != "y" ]; then
    echo -e "\033[31mVeuillez lire le fichier avec : cat /tmp/suspect_email.txt\033[0m"
    echo "Et relancez ensuite la commande : gsh"
    exit 0
  fi

  echo -ne "\nğŸŸ¡ Tapez votre rÃ©ponse : Quel est lâ€™objet de lâ€™email ? "
  read user_answer

  # Exemple dâ€™acceptation de "mise Ã  jour" ou "mise Ã  jour de votre profil"
  if echo "$user_answer" | grep -iq "mise Ã  jour"; then
    echo -e "\nâœ… \033[32mÃ‰tape 1 validÃ©e !\033[0m"
    echo -e ""
    echo -e "Ã‰tape suivante : Analyse du lien suspect."
    echo -e "Utilisez la commande : gsh"
    echo ""
    echo 2 > "$step_file"
  else
    echo -e "\033[31mâŒ Ce nâ€™est pas la bonne rÃ©ponse. Relisez bien le sujet de lâ€™email.\033[0m"
  fi

  exit 0
fi


# Ã‰tape 2 : VÃ©rification du domaine
if [ "$step" = "2" ]; then
  echo -e "\n\033[36mğŸ” Ã‰tape 2 : Analyse du lien suspect dans lâ€™email.\033[0m"
  echo -e "Le lien affichÃ© est : http://allopneus-rh-update.com/activation"
  echo -e "Question : Ce domaine est-il vraiment celui d'Allopneus ?"
  echo -e "\033[37mEntrez le domaine de lâ€™entreprise aprÃ¨s vÃ©rification (ex: google.com) :\033[0m"
  read user_input
  if [[ "$user_input" == "allopneus.com" ]]; then
    echo -e "\033[32mâœ… Ã‰tape 2 validÃ©e !\033[0m"
    echo "Prochaine Ã©tape : vÃ©rifiez lâ€™identitÃ© de lâ€™expÃ©diteur dans les en-tÃªtes (headers)."
    echo "Utilisez la commande : gsh"
    echo ""
    echo 3 > "$step_file"
  else
    echo -e "\033[31mâŒ Ce nâ€™est pas le bon domaine. Essayez encore.\033[0m"
  fi
  exit 0
fi

# Ã‰tape 3 : Analyse headers
if [ "$step" = "3" ]; then
    echo -e "\n\033[36mğŸ”µ Ã‰tape 3 : VÃ©rifiez les en-tÃªtes d'email.\033[0m"
    echo "Fichier Ã  consulter : /tmp/headers.txt"
    echo "Utilisez la commande : cat /tmp/headers.txt"
    echo -e "\033[33m(Note : La rÃ©ponse ne sera disponible qu'aprÃ¨s lecture du fichier)\033[0m"

    if [ ! -f /tmp/.headers_read ]; then
        read -p "Avez-vous lu le fichier ? (y/n) : " user_input
        if [[ "$user_input" =~ ^[Yy]$ ]]; then
            touch /tmp/.headers_read
        else
            echo -e "\033[31mVeuillez lire le fichier avec : cat /tmp/headers.txt\033[0m"
            echo "Et relancez ensuite la commande : gsh"
            exit 0
        fi
    fi

    echo -e "\nQuestion : Quelle anomalie remarquez-vous dans le champ 'From' ?"
    read user_answer
    if echo "$user_answer" | grep -iq "rh-update\|domaine\|inconnu\|gmail\|pass"; then
        echo -e "\033[32mâœ… Ã‰tape 3 validÃ©e !\033[0m"
        echo "Ã‰tape suivante : VÃ©rifiez le lien cachÃ© dans le fichier hidden_link.txt"
        echo "Utilisez la commande : gsh"
        echo ""
        echo 4 > "$step_file"
        exit 0
    else
        echo -e "\033[31mâŒ Ce nâ€™est pas ce quâ€™on attendait. VÃ©rifie bien les headers.\033[0m"
        exit 0
    fi
fi



# Ã‰tape 4 : Analyse du lien cachÃ©
if [ "$step" = "4" ]; then
    echo -e "\n\033[36mğŸ”· Ã‰tape 4 : Analysez le lien cachÃ© dans /tmp/hidden_link.txt\033[0m"
    echo "Quel est le domaine du lien cachÃ© ?"
    echo "Utilisez la commande : cat /tmp/hidden_link.txt"
    echo -e "\033[33m(Note : La rÃ©ponse ne sera disponible qu'aprÃ¨s lecture du fichier)\033[0m"

    if [ ! -f /tmp/.hidden_link_read ]; then
        read -p "Avez-vous lu le fichier ? (y/n) : " user_input
        if [[ "$user_input" =~ ^[Yy]$ ]]; then
            touch /tmp/.hidden_link_read
        else
            echo -e "\033[31mVeuillez lire le fichier avec : cat /tmp/hidden_link.txt\033[0m"
            echo "Et relancez ensuite la commande : gsh"
            exit 0
        fi
    fi

    echo -e "\nQuestion : Quel est le domaine du lien cachÃ© ?"
    read user_answer
    if echo "$user_answer" | grep -iq "fake-login\|frroot\|fake-login.frroot\|"; then
        echo -e "\033[32mâœ… Ã‰tape 4 validÃ©e !\033[0m"
        echo "Ã‰tape suivante : Continuez l'analyse du message."
        echo "Utilisez la commande : gsh"
        echo ""
        echo 5 > "$step_file"
        exit 0
    else
        echo -e "\033[31mâŒ Ce nâ€™est pas le bon domaine. RevÃ©rifiez le lien.\033[0m"
        exit 0
    fi
fi


# Ã‰tape 5 : Linkdn
if [ "$step" = "5" ]; then
  echo -e "\n\033[36mğŸ” Ã‰tape 5 : VÃ©rifiez le profil LinkedIn de lâ€™expÃ©diteur.\033[0m"
  echo "Nom affichÃ© dans l'email : Alice PIERRE"
  echo -e "Recherchez ce nom sur LinkedIn.\n"
  echo -e "\033[33m(Note : Utilisez un navigateur externe si nÃ©cessaire pour faire la recherche)\033[0m"

  read -p "La personne travaille-t-elle rÃ©ellement chez Allopneus ? (y/n) : " answer1
  if echo "$answer1" | grep -iq "^n"; then
    read -p "Selon le profil LinkedIn, dans quelle entreprise travaille-t-elle rÃ©ellement ? : " real_company
    if echo "$real_company" | grep -iq "Adoma\|Groupe IGS\|IGS\|pass"; then
      echo -e "\033[32mâœ… Ã‰tape 5 validÃ©e : Lâ€™identitÃ© de lâ€™expÃ©diteur a Ã©tÃ© falsifiÃ©e.\033[0m"
      echo -e "Ã‰tape suivante : Inspectez la piÃ¨ce jointe 'fiche.pdf.fake'"
      echo "Utilisez la commande : gsh"
      echo ""
      echo 6 > "$step_file"
      exit 0
    else
      echo -e "\033[31mâŒ Ce nâ€™est pas lâ€™entreprise attendue. RevÃ©rifiez bien le profil LinkedIn.\033[0m"
      exit 0
    fi
  else
    echo -e "\033[31mâŒ RevÃ©rifiez le profil LinkedIn. La personne ne semble pas liÃ©e Ã  Allopneus.\033[0m"
    exit 0
  fi
fi


# Ã‰tape 6 : PDF
if [ "$step" == "6" ]; then
    echo -e "\n\033[36mğŸ” Ã‰tape 6 : Analyse des connexions systÃ¨me.\033[0m"
    echo "Fichier Ã  consulter : /tmp/auth.log"
    echo "Utilisez la commande : cat /tmp/auth.log"
    echo -e "\033[33m(Note : La rÃ©ponse ne sera disponible qu'aprÃ¨s lecture du fichier)\033[0m"

    read -p "Avez-vous lu le fichier ? (y/n) : " read_file
    if [[ "$read_file" != "y" ]]; then
        echo -e "\033[31mVeuillez lire le fichier avec : cat /tmp/auth.log\033[0m"
        echo "Et relancez ensuite la commande : gsh"
        exit 0
    fi

    echo -e "\nğŸŸ¡ Question : Quelle commande inhabituelle a Ã©tÃ© exÃ©cutÃ©e rÃ©cemment ?"
    read user_answer
    if echo "$user_answer" | grep -iq "curl\|wget\|pass"; then
        echo -e "\033[32mâœ… Ã‰tape 6 validÃ©e !\033[0m"
        echo ""
        echo -e "Ã‰tape suivante : \033[31mEn cours de dÃ©veloppement !\033[0m"
	echo ""
        echo -e "\033[32mMERCI D'AVOIR PARTICIPE A CETTE ENTRAINEMENT !\033[0m"
        echo 7 > "$step_file"
	exit 0
     else
      echo -e "\033[31mâŒ Ce nâ€™est pas lâ€™IP attendue. RevÃ©rifiez les logs.\033[0m"
      exit 0
    fi
  else
    echo -e "\033[31mâ—Veuillez lire le fichier avec : cat /tmp/auth.log\033[0m"
    echo "Et relancez ensuite la commande : gsh"
    exit 0
  fi
fi

