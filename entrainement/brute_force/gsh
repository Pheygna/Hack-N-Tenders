#!/bin/bash

step_file="/root/.brute_step"
[ ! -f "$step_file" ] && echo 1 > "$step_file"
step=$(cat "$step_file")

# Ã‰tape 1
if [[ "$step" == "1" ]]; then
    echo -e "\nğŸ” \033[36mÃ‰tape 1 : Analyser les logs d'authentification.\033[0m"
    echo "Commande utile : grep 'Failed password' /tmp/auth_attempts.log"

    read -p "Avez-vous identifiÃ© les tentatives Ã©chouÃ©es ? (y/n) : " confirm
    if [[ "$confirm" != "y" ]]; then
        echo -e "\033[31mğŸ’¡ Conseil : Utilisez grep pour trouver les tentatives Ã©chouÃ©es.\033[0m"
        exit 0
    fi

    echo -e "\nğŸŸ¡ Question : Quelle adresse IP a gÃ©nÃ©rÃ© le plus d'Ã©checs ?"
    read answer
    if [[ "$answer" == "192.168.1.45" ]]; then
        echo -e "\033[32mâœ… Ã‰tape 1 validÃ©e !\033[0m"
	echo ""
        echo 2 > "$step_file"
    else
        echo -e "\033[31mâŒ Mauvaise rÃ©ponse. Relisez bien les logs.\033[0m"
    fi
    exit 0
fi

# Ã‰tape 2
if [[ "$step" == "2" ]]; then
    echo -e "\nğŸ” \033[36mÃ‰tape 2 : Rechercher les connexions rÃ©ussies.\033[0m"
    echo "Commande utile : grep 'Accepted password' /tmp/auth_attempts.log"

    read -p "Avez-vous trouvÃ© une connexion rÃ©ussie suspecte ? (y/n) : " confirm
    if [[ "$confirm" != "y" ]]; then
        echo -e "\033[31mğŸ’¡ Conseil : Les connexions rÃ©ussies peuvent aussi rÃ©vÃ©ler une faille.\033[0m"
        exit 0
    fi

    echo -e "\nğŸŸ¡ Question : Quel compte a Ã©tÃ© compromis ?"
    read answer
    if echo "$answer" | grep -iq "user support\|usersupport"; then
        echo -e "\033[32mâœ… Ã‰tape 2 validÃ©e !\033[0m"
	echo ""
        echo 3 > "$step_file"
    else
        echo -e "\033[31mâŒ Mauvaise rÃ©ponse. Qui a rÃ©ussi Ã  se connecter ?\033[0m"
    fi
    exit 0
fi

# Ã‰tape 3
if [[ "$step" == "3" ]]; then
    echo -e "\nğŸ“˜ \033[36mÃ‰tape 3 : Identifier les mots de passe faibles utilisÃ©s.\033[0m"
    echo "Commande utile : grep -Ff /tmp/common_passwords.txt /tmp/auth_attempts.log"

    read -p "Avez-vous repÃ©rÃ© un mot de passe faible utilisÃ© ? (y/n) : " confirm
    if [[ "$confirm" != "y" ]]; then
        echo -e "\033[31mğŸ’¡ Conseil : croisez les mots de passe communs avec les logs.\033[0m"
        exit 0
    fi

    echo -e "\nğŸŸ¡ Question : Quel mot de passe connu a Ã©tÃ© utilisÃ© ?"
    read answer
    if echo "$answer" | grep -iqE "admin123|root|admin|123456"; then
        echo -e "\033[32mâœ… Ã‰tape 3 validÃ©e !\033[0m"
	echo ""
        echo 4 > "$step_file"
    else
        echo -e "\033[31mâŒ RÃ©essayez. Essayez avec grep -Ff.\033[0m"
    fi
    exit 0
fi

# Ã‰tape 4
if [[ "$step" == "4" ]]; then
    echo -e "\nğŸ” \033[36mÃ‰tape 4 : Utiliser les outils pour extraire les IP uniques.\033[0m"
    echo "Commande utile : awk '{print \$11}' /tmp/auth_attempts.log | sort | uniq -c"

    read -p "Avez-vous extrait les IP ? (y/n) : " confirm
    if [[ "$confirm" != "y" ]]; then
        echo -e "\033[31mğŸ’¡ Astuce : awk + sort + uniq est trÃ¨s puissant !\033[0m"
        exit 0
    fi

    echo -e "\nğŸŸ¡ Question : Combien dâ€™adresses IP diffÃ©rentes figurent dans le log ?"
    read answer
    if [[ "$answer" == "2" ]]; then
        echo -e "\033[32mâœ… Ã‰tape 4 validÃ©e !\033[0m"
	echo ""
        echo 5 > "$step_file"
    else
        echo -e "\033[31mâŒ Mauvaise rÃ©ponse. Relancez la commande dâ€™analyse dâ€™IP.\033[0m"
    fi
    exit 0
fi

# Ã‰tape 5
if [[ "$step" == "5" ]]; then
    echo -e "\nğŸ“˜ \033[36mÃ‰tape 5 : Lire le rapport de sÃ©curitÃ©.\033[0m"
    echo "Fichier Ã  consulter : cat /tmp/security_summary.txt"

    read -p "Avez-vous lu le rapport ? (y/n) : " confirm
    if [[ "$confirm" != "y" ]]; then
        echo -e "\033[31mğŸ’¡ Conseil : cat /tmp/security_summary.txt\033[0m"
        exit 0
    fi

    echo -e "\nğŸ‰ \033[32mFÃ©licitations, vous avez terminÃ© le scÃ©nario Brute Force !\033[0m"
    echo -e "ğŸ›¡ï¸  Pensez Ã  sÃ©curiser SSH, dÃ©sactiver root distant, et activer fail2ban."
    rm -f "$step_file"
    exit 0
fi
