#!/bin/bash

step_file="/root/.sqlinj_step"
if [ ! -f "$step_file" ]; then echo 1 > "$step_file"; fi
step=$(cat "$step_file")

# Ã‰tape 1 : Lecture du fichier de log
if [[ "$step" == "1" ]]; then
    echo -e "\nğŸ“˜ \033[36mÃ‰tape 1 : Lecture du journal des requÃªtes SQL.\033[0m"
    echo "Fichier Ã  consulter : /tmp/logs_sql.log"
    echo "Utilisez la commande : cat /tmp/logs_sql.log"
    echo -e "\033[33m(Note : La rÃ©ponse ne sera disponible qu'aprÃ¨s lecture du fichier)\033[0m"

    read -p "Avez-vous lu le fichier ? (y/n) : " read_file
    if [[ "$read_file" != "y" ]]; then
        echo -e "\033[31mVeuillez lire le fichier avec : cat /tmp/logs_sql.log\033[0m"
        echo "Et relancez ensuite la commande : gsh"
        exit 0
    fi

    echo -e "\nğŸŸ¡ Question : Quelle requÃªte suspecte peut indiquer une tentative dâ€™injection ?"
    read user_answer

    if echo "$user_answer" | grep -iqE "or.?1=1"; then
        echo -e "\033[32mâœ… Ã‰tape 1 validÃ©e !\033[0m"
        echo "Ã‰tape suivante : Analyse de la base de donnÃ©es"
        echo "Utilisez la commande : gsh"
	echo ""
        echo 2 > "$step_file"
    else
        echo -e "\033[31mâŒ Mauvaise rÃ©ponse. Indice : une requÃªte toujours vraie.\033[0m"
    fi
    exit 0
fi

# Ã‰tape 2 : Analyse de la base SQLite
if [[ "$step" == "2" ]]; then
    echo -e "\033[36mğŸ”¹ Ã‰tape 2 : Analyse de la base de donnÃ©es SQLite.\033[0m"
    echo "Fichier Ã  analyser : /tmp/db.sqlite"
    echo "Utilisez la commande : sqlite3 /tmp/db.sqlite"
    echo -e "\033[33m(Note : Cherchez les utilisateurs ou comptes exposÃ©s)\033[0m"
    echo
    echo -e "\033[35mğŸ’¡ Astuce : Une fois dans sqlite3, essayez les commandes suivantes :\033[0m"
    echo -e "   \033[32m.tables\033[0m               â†’ pour afficher les tables disponibles"
    echo -e "   \033[32mSELECT * FROM users;\033[0m   â†’ pour voir le contenu de la table 'users'"
    echo -e "   \033[32m.schema users\033[0m          â†’ pour voir la structure de la table"
    echo

    read -p "Avez-vous analysÃ© la base ? (y/n) : " read_db
    if [[ "$read_db" != "y" ]]; then
      echo -e "\033[31mVeuillez ouvrir la base avec : sqlite3 /tmp/db.sqlite\033[0m"
      echo "Et relancez ensuite la commande : gsh"
      exit 0
    fi

    echo -e "\nğŸŸ¡ Question : Combien de comptes utilisateurs y a-t-il ?"
    read user_answer

    if [[ "$user_answer" == "3" ]]; then
        echo -e "\033[32mâœ… Ã‰tape 2 validÃ©e !\033[0m"
        echo "Ã‰tape suivante : Analyse de lâ€™exfiltration"
        echo "Utilisez la commande : gsh"
	echo ""
        echo 3 > "$step_file"
    else
        echo -e "\033[31mâŒ Ce nâ€™est pas le bon nombre de comptes. VÃ©rifiez avec une requÃªte SQL.\033[0m"
    fi
    exit 0
fi

# Ã‰tape 3 : Fichier dâ€™exfiltration
if [[ "$step" == "3" ]]; then
    echo -e "\nğŸ“˜ \033[36mÃ‰tape 3 : Analyse du fichier dâ€™exfiltration\033[0m"
    echo "Fichier Ã  consulter : /tmp/result_exfiltration.txt"
    echo "Utilisez la commande : cat /tmp/result_exfiltration.txt"

    read -p "Avez-vous lu le fichier ? (y/n) : " read_exfil
    if [[ "$read_exfil" != "y" ]]; then
        echo -e "\033[31mVeuillez lire le fichier avec : cat /tmp/result_exfiltration.txt\033[0m"
        echo "Et relancez ensuite la commande : gsh"
        exit 0
    fi

    echo -e "\nğŸŸ¡ Question : Quelle donnÃ©e sensible a Ã©tÃ© exfiltrÃ©e ?"
    read user_answer

    if echo "$user_answer" | grep -iq "mot de passe\|mdp\|password"; then
        echo -e "\033[32mâœ… Ã‰tape 3 validÃ©e !\033[0m"
        echo "Ã‰tape suivante : Analyse des hashs SHA-256"
        echo "Utilisez la commande : gsh"
        echo ""
        echo 4 > "$step_file"
    else
        echo -e "\033[31mâŒ Ce nâ€™est pas la bonne rÃ©ponse. Lisez bien le fichier.\033[0m"
    fi
    exit 0
fi

# Ã‰tape 4 : DÃ©codage base64 du mot de passe
if [[ "$step" == "4" ]]; then
    echo -e "\nğŸ“˜ \033[36mÃ‰tape 4 : DÃ©codage base64 du mot de passe\033[0m"
    echo -e "Le mot de passe chiffrÃ© de lâ€™utilisateur \033[33madmin\033[0m est : \033[33mYWRtaW5wYXNz\033[0m"
    echo -e "\033[35mğŸ’¡ Astuce : Utilisez la commande \033[32mecho '...' | base64 -d; echo\033[0m pour le dÃ©coder."
    
    read -p "Avez-vous lu le fichier ? (y/n) : " read_exfil
    if [[ "$read_exfil" != "y" ]]; then
        echo -e "\033[31mVeuillez lire le fichier avec : cat /tmp/result_exfiltration.txt\033[0m"
        echo "Et relancez ensuite la commande : gsh"
        exit 0
    fi

    echo -e "\nğŸŸ¡ Question : Quel est le mot de passe dâ€™origine ?"
    read user_answer

    if echo "$user_answer" | grep -iq "^adminpass$"; then
        echo -e "\033[32mâœ… Ã‰tape 4 validÃ©e !\033[0m"
        echo -e "\nğŸ‰ \033[32mFÃ©licitations, vous avez terminÃ© l'entraÃ®nement SQL Injection !\033[0m"
        echo -e "ğŸ›¡ï¸ Pensez Ã  vÃ©rifier vos entrÃ©es utilisateur et Ã  protÃ©ger vos bases de donnÃ©es.\n"
        rm -f "$step_file"
    else
        echo -e "\033[31mâŒ Mauvaise rÃ©ponse. Essayez avec la commande base64 -d.\033[0m"
    fi
    exit 0
fi



# Ã‰tape 5 : RÃ©sumÃ©
if [[ "$step" == "5" ]]; then
    echo -e "\nğŸ¯ \033[32mFÃ©licitations, vous avez terminÃ© l'entraÃ®nement SQL Injection !\033[0m"
    echo -e "\nğŸ“˜ \033[34mRÃ©capitulatif :\033[0m"
    echo "- Tentative dâ€™injection dÃ©tectÃ©e dans les logs"
    echo "- Base de donnÃ©es compromise"
    echo "- DonnÃ©es exfiltrÃ©es (mots de passe)"
    echo "- Hash SHA-256 identifiÃ© et dÃ©chiffrÃ©"
    echo
    echo -e "ğŸ›¡ï¸ \033[33mPensez Ã  utiliser des requÃªtes prÃ©parÃ©es et Ã  protÃ©ger vos entrÃ©es utilisateur !\033[0m"
    rm -f "$step_file"
    exit 0
fi
